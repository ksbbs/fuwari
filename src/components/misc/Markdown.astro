---
import "@fontsource-variable/jetbrains-mono";
import "@fontsource-variable/jetbrains-mono/wght-italic.css";

interface Props {
	class: string;
}
const className = Astro.props.class;
---
<div data-pagefind-body class=`prose dark:prose-invert prose-base !max-w-none custom-md break-words ${className}`>
    <!--<div class="prose dark:prose-invert max-w-none custom-md">-->
    <!--<div class="max-w-none custom-md">-->
    <slot/>
</div>

<script>
const wrapMarkdownTables = () => {
    document.querySelectorAll(".custom-md table").forEach((table) => {
        const parent = table.parentElement;
        if (parent && parent.classList.contains("table-wrapper")) return;

        const wrapper = document.createElement("div");
        wrapper.className = "table-wrapper";
        table.parentNode?.insertBefore(wrapper, table);
        wrapper.appendChild(table);
    });
};

if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wrapMarkdownTables);
} else {
    wrapMarkdownTables();
}

if ((window as any).swup?.hooks) {
    (window as any).swup.hooks.on("page:view", wrapMarkdownTables);
}

document.addEventListener("click", function (e: MouseEvent) {
    const target = e.target as Element | null;
    if (target && target.classList.contains("copy-btn")) {
        const preEle = target.closest("pre");
        const codeEle = preEle?.querySelector("code");
        const code = Array.from(codeEle?.querySelectorAll(".code:not(summary *)") ?? [])
            .map(el => el.textContent)
            .map(t => t === "\n" ? "" : t)
            .join("\n");
        navigator.clipboard.writeText(code);

        const timeoutId = target.getAttribute("data-timeout-id");
        if (timeoutId) {
            clearTimeout(parseInt(timeoutId));
        }

      target.classList.add("success");

      // 设置新的timeout并保存ID到按钮的自定义属性中
        const newTimeoutId = setTimeout(() => {
            target.classList.remove("success");
        }, 1000);
        target.setAttribute("data-timeout-id", newTimeoutId.toString());
    }

    const spoiler = target?.closest(".spoiler");
    if (spoiler) {
        const isVisible = spoiler.classList.contains("visible");
        const isLink = target?.closest("a");
        const isCopyBtn = target?.closest(".copy-btn");
        
        if (!isVisible) {
            // Reveal
            spoiler.classList.add("visible");
            spoiler.setAttribute("title", "");
            e.preventDefault();
            e.stopPropagation();
        } 
        // If visible, do nothing. Let the event propagate to Fancybox or other handlers.
    }
}, true); // Use capture to prevent Fancybox from opening on first click
</script>

<style is:global>
    .spoiler {
        filter: blur(0.4rem);
        transition: filter 0.3s;
        cursor: pointer;
        user-select: none;
    }
    .spoiler:hover {
        opacity: 0.8;
    }
    .spoiler.visible {
        filter: none;
        user-select: auto;
        cursor: auto; /* Restore default cursor (or zoom-in for fancybox) */
        opacity: 1;
    }
</style>
