<div id="diff-debug-editor-root" class="hidden" data-swup-ignore-script></div>

<script>
	import * as Diff from "diff";

	const DEBUG_PARAM_KEY = "__diff_debug";
	const DEBUG_STATE_KEY = "fuwari-diff-debug-state";
	const NOTIFICATION_STATE_KEY = "fuwari-notification-state";

	const OLD_DB_NAME = "fuwari-diff-debug-old";
	const NEW_DB_NAME = "fuwari-diff-debug-new";
	const DB_VERSION = 1;
	const STORE_NAME = "posts";

	function normalizePathname(pathname) {
		const p = String(pathname || "");
		if (!p) return "/";
		const noQueryHash = p.split("#")[0].split("?")[0];
		if (noQueryHash.length > 1) return noQueryHash.replace(/\/+$/, "");
		return "/";
	}

	function getRelativePath(absoluteUrl) {
		try {
			const url = new URL(absoluteUrl, window.location.origin);
			return `${url.pathname}${url.search}${url.hash}`;
		} catch {
			return String(absoluteUrl || "");
		}
	}

	function normalizeGuid(guid, link) {
		const value = (guid || link || "").trim();
		if (!value) return "";
		try {
			const url = new URL(value, window.location.origin);
			return `${url.pathname}${url.search}${url.hash}`;
		} catch {
			return value;
		}
	}

	function normalizeRaw(text) {
		const s = String(text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
		const lines = s.split("\n").map((line) => line.replace(/[ \t]+$/g, ""));
		return lines.join("\n").trim();
	}

	function normalizeForDiffHtml(html) {
		const raw = normalizeRaw(html);
		if (!raw) return "";
		const parser = new DOMParser();
		const doc = parser.parseFromString(`<div>${raw}</div>`, "text/html");
		const root = doc.body.firstElementChild;
		if (!root) return raw;

		const lines = [];
		for (const el of Array.from(root.children)) {
			const htmlLine = String(el.outerHTML || "")
				.replace(/\r\n/g, "\n")
				.replace(/\r/g, "\n")
				.replace(/\n+/g, " ")
				.replace(/[ \t]+/g, " ")
				.trim();
			if (!htmlLine) continue;
			lines.push(htmlLine);
		}

		return lines.join("\n");
	}

	function openDb(name) {
		return new Promise((resolve, reject) => {
			const request = indexedDB.open(name, DB_VERSION);
			request.onerror = () => reject(request.error);
			request.onsuccess = () => resolve(request.result);
			request.onupgradeneeded = (event) => {
				const db = event.target.result;
				if (!db.objectStoreNames.contains(STORE_NAME)) {
					db.createObjectStore(STORE_NAME, { keyPath: "path" });
				}
			};
		});
	}

	function idbGet(db, path) {
		return new Promise((resolve, reject) => {
			const tx = db.transaction([STORE_NAME], "readonly");
			const store = tx.objectStore(STORE_NAME);
			const req = store.get(path);
			req.onsuccess = () => resolve(req.result || null);
			req.onerror = () => reject(req.error);
		});
	}

	function idbPut(db, record) {
		return new Promise((resolve, reject) => {
			const tx = db.transaction([STORE_NAME], "readwrite");
			const store = tx.objectStore(STORE_NAME);
			const req = store.put(record);
			req.onsuccess = () => resolve(true);
			req.onerror = () => reject(req.error);
		});
	}

	function deleteDb(name) {
		return new Promise((resolve) => {
			const req = indexedDB.deleteDatabase(name);
			req.onsuccess = () => resolve(true);
			req.onerror = () => resolve(true);
			req.onblocked = () => resolve(true);
		});
	}

	function fetchRssItemForPath(targetPath) {
		return fetch("/rss.xml", { cache: "no-store" })
			.then((r) => r.text())
			.then((text) => {
				const parser = new DOMParser();
				const xml = parser.parseFromString(text, "text/xml");

				const channelLink = xml.querySelector("channel > link")?.textContent?.trim();
				let prodOrigin = "";
				if (channelLink) {
					try {
						prodOrigin = new URL(channelLink).origin;
					} catch {}
				}
				const currentOrigin = window.location.origin;

				const items = Array.from(xml.querySelectorAll("item"));

				for (const item of items) {
					const title = item.querySelector("title")?.textContent || "";
					let link = (item.querySelector("link")?.textContent || "").trim();
					let rawGuid = (item.querySelector("guid")?.textContent || "").trim();
					const description = item.querySelector("description")?.textContent || "";

					let contentEncoded =
						item.getElementsByTagNameNS("http://purl.org/rss/1.0/modules/content/", "encoded")[0]?.textContent ||
						item.getElementsByTagName("content:encoded")[0]?.textContent ||
						item.querySelector("content")?.textContent ||
						"";

					if (prodOrigin && prodOrigin !== currentOrigin) {
						link = link.replaceAll(prodOrigin, currentOrigin);
						if (rawGuid.includes(prodOrigin)) {
							rawGuid = rawGuid.replaceAll(prodOrigin, currentOrigin);
						}
						contentEncoded = contentEncoded.replaceAll(prodOrigin, currentOrigin);
					}

					const guid = normalizeGuid(rawGuid || link, link);
					const pubDate = new Date(item.querySelector("pubDate")?.textContent || "").getTime();

					const guidPath = normalizePathname(guid);
					const linkPath = normalizePathname(getRelativePath(link));
					if (guidPath !== targetPath && linkPath !== targetPath) continue;

					return {
						title,
						link,
						guid,
						pubDate,
						description,
						content: contentEncoded,
					};
				}

				return null;
			})
			.catch(() => null);
	}

	function computeDiff(oldHtml, newHtml) {
		const a = normalizeForDiffHtml(oldHtml);
		const b = normalizeForDiffHtml(newHtml);
		if (!a || !b) return null;
        
		const diffs = Diff.diffLines(a, b);
		const hasChanges = diffs.some((p) => p.added || p.removed);
		if (!hasChanges) return null;
		return diffs;
	}

	function computeDiffWithMeta(oldRecord, newRecord) {
		const oldHtml = oldRecord.html || "";
		const newHtml = newRecord.html || oldHtml;
		
		const oldTitle = oldRecord.title || "";
		const newTitle = newRecord.title || oldTitle;

		const oldDesc = oldRecord.description || "";
		const newDesc = newRecord.description || oldDesc;

		const result = {};
		let hasChanges = false;

		const diffContent = computeDiff(oldHtml, newHtml);
		if (diffContent) {
			result.content = diffContent;
			hasChanges = true;
		}

		if (oldDesc !== newDesc) {
			result.description = Diff.diffChars(oldDesc, newDesc);
			hasChanges = true;
		}

		if (oldTitle !== newTitle) {
			result.title = Diff.diffChars(oldTitle, newTitle);
			hasChanges = true;
		}

		if (!hasChanges) return null;
		
		return { diff: result, diffType: 'composite' };
	}

	function ensureDiffUrl() {
		const url = new URL(window.location.href);
		if (!url.searchParams.has(DEBUG_PARAM_KEY)) url.searchParams.set(DEBUG_PARAM_KEY, "1");
		url.searchParams.set("diff", "1");
		url.hash = "post-diff";
		history.replaceState({}, "", `${url.pathname}${url.search}${url.hash}`);
	}

	function clearNonDebugState() {
		localStorage.removeItem(NOTIFICATION_STATE_KEY);
	}

	function setDebugStateForCurrentPost(post, diffResult) {
		const state = {
			timestamp: Date.now(),
			items: [
				{
					title: post?.title,
					link: post?.link,
					guid: post?.guid,
					pubDate: post?.pubDate,
					isUpdated: true,
					diff: diffResult.diff,
					diffType: diffResult.diffType
				},
			],
		};
		sessionStorage.setItem(DEBUG_STATE_KEY, JSON.stringify(state));
	}

	function dispatchApply() {
		try {
			window.dispatchEvent(new Event("fuwari:diff-debug-updated"));
		} catch {
		}
	}

	function render(root, model) {
		root.classList.remove("hidden");

		const panel = document.createElement("div");
		panel.id = "diff-debug-editor";
		panel.className =
			"fixed bottom-4 left-4 z-[9999] w-[min(40rem,calc(100vw-2rem))] max-h-[75vh] overflow-hidden rounded-xl border border-black/10 dark:border-white/10 bg-[var(--card-bg)] shadow-lg";

		const header = document.createElement("div");
		header.className = "flex items-center justify-between gap-3 px-4 py-3 border-b border-black/10 dark:border-white/10";

		const title = document.createElement("div");
		title.className = "text-sm font-bold text-black/80 dark:text-white/80 truncate";
		title.textContent = `DIFF 调试（${model.path}）`;

		const btnBar = document.createElement("div");
		btnBar.className = "flex items-center gap-2";

		const btnClose = document.createElement("button");
		btnClose.className =
			"text-xs px-2 py-1 rounded bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 text-black/70 dark:text-white/70";
		btnClose.textContent = "关闭并清理";

		btnBar.appendChild(btnClose);
		header.appendChild(title);
		header.appendChild(btnBar);

		const body = document.createElement("div");
		body.className = "p-4 overflow-auto max-h-[calc(75vh-3.25rem)]";

		const titleLabel = document.createElement("div");
		titleLabel.className = "text-[11px] text-black/50 dark:text-white/50 mb-1 font-bold";
		titleLabel.textContent = "标题 (Title)";

		const oldTitleInput = document.createElement("input");
		oldTitleInput.className = "w-full text-xs p-1 mb-1 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/50 dark:text-white/50";
		oldTitleInput.readOnly = true;
		oldTitleInput.value = model.oldTitle || "";
		oldTitleInput.placeholder = "旧标题";

		const newTitleInput = document.createElement("input");
		newTitleInput.className = "w-full text-xs p-1 mb-3 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/80 dark:text-white/80";
		newTitleInput.value = model.newTitle || "";
		newTitleInput.placeholder = "新标题 (修改此处以测试标题Diff)";

		const descLabel = document.createElement("div");
		descLabel.className = "text-[11px] text-black/50 dark:text-white/50 mb-1 font-bold";
		descLabel.textContent = "简介 (Description)";

		const oldDescArea = document.createElement("textarea");
		oldDescArea.className = "w-full h-16 text-xs p-1 mb-1 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/50 dark:text-white/50";
		oldDescArea.readOnly = true;
		oldDescArea.value = model.oldDesc || "";
		oldDescArea.placeholder = "旧简介";

		const newDescArea = document.createElement("textarea");
		newDescArea.className = "w-full h-16 text-xs p-1 mb-3 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/80 dark:text-white/80";
		newDescArea.value = model.newDesc || "";
		newDescArea.placeholder = "新简介 (修改此处以测试简介Diff)";

		const oldLabel = document.createElement("div");
		oldLabel.className = "text-[11px] text-black/50 dark:text-white/50 mb-1 font-bold";
		oldLabel.textContent = "旧内容 (Content)";

		const oldArea = document.createElement("textarea");
		oldArea.className =
			"w-full h-32 text-[11px] leading-relaxed p-2 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/70 dark:text-white/70";
		oldArea.readOnly = true;
		oldArea.value = model.oldHtml || "";

		const newLabel = document.createElement("div");
		newLabel.className = "text-[11px] text-black/50 dark:text-white/50 mb-1 mt-3 font-bold";
		newLabel.textContent = "新内容 (Content)";

		const newArea = document.createElement("textarea");
		newArea.className =
			"w-full h-44 text-[11px] leading-relaxed p-2 rounded border border-black/10 dark:border-white/10 bg-[var(--card-bg)] text-black/80 dark:text-white/80";
		newArea.value = model.newHtml || "";

		const actions = document.createElement("div");
		actions.className = "mt-3 flex flex-wrap gap-2";

		const btnSave = document.createElement("button");
		btnSave.className =
			"text-xs px-2 py-1 rounded bg-[var(--primary)]/10 hover:bg-[var(--primary)]/15 text-[var(--primary)]";
		btnSave.textContent = "保存并生成 DIFF";

		const status = document.createElement("div");
		status.className = "text-[11px] text-black/40 dark:text-white/40 self-center";
		status.textContent = model.status || "";

		actions.appendChild(btnSave);
		actions.appendChild(status);

		body.appendChild(titleLabel);
		body.appendChild(oldTitleInput);
		body.appendChild(newTitleInput);
		
		body.appendChild(descLabel);
		body.appendChild(oldDescArea);
		body.appendChild(newDescArea);

		body.appendChild(oldLabel);
		body.appendChild(oldArea);
		body.appendChild(newLabel);
		body.appendChild(newArea);
		body.appendChild(actions);

		panel.appendChild(header);
		panel.appendChild(body);
		root.innerHTML = "";
		root.appendChild(panel);

		btnSave.onclick = async () => {
			const dbNew = await openDb(NEW_DB_NAME);
			const newRecord = {
				path: model.path,
				guid: model.post.guid,
				link: model.post.link,
				title: newTitleInput.value,
				description: newDescArea.value,
				pubDate: model.post.pubDate,
				html: normalizeRaw(newArea.value),
				updatedAt: Date.now(),
			};

			await idbPut(dbNew, newRecord);
			dbNew.close();

			const oldRec = {
				html: model.oldHtml,
				title: model.oldTitle,
				description: model.oldDesc
			};
			const newRec = {
				html: normalizeRaw(newArea.value),
				title: newTitleInput.value,
				description: newDescArea.value
			};

			const diffResult = computeDiffWithMeta(oldRec, newRec);
			if (!diffResult) {
				status.textContent = "未检测到任何变更";
				return;
			}

			setDebugStateForCurrentPost(model.post, diffResult);
			ensureDiffUrl();
			dispatchApply();
		};

		btnClose.onclick = async () => {
			sessionStorage.removeItem(DEBUG_STATE_KEY);
			clearNonDebugState();
			await deleteDb(OLD_DB_NAME);
			await deleteDb(NEW_DB_NAME);
			await deleteDb("fuwari-rss-store");
			const url = new URL(window.location.href);
			url.searchParams.delete(DEBUG_PARAM_KEY);
			url.searchParams.delete("diff");
			url.searchParams.set("__diff_debug_cleanup", "1");
			url.hash = "";
			window.location.href = `${url.pathname}${url.search}${url.hash}`;
		};
	}

	async function init() {
		const root = document.getElementById("diff-debug-editor-root");
		if (!(root instanceof HTMLElement)) return;

		const sp = new URLSearchParams(window.location.search);
		if (sp.get(DEBUG_PARAM_KEY) !== "1") return;

		const path = normalizePathname(window.location.pathname);
		if (!path.startsWith("/posts/")) return;

		clearNonDebugState();

		const dbOld = await openDb(OLD_DB_NAME);
		let oldRecord = await idbGet(dbOld, path);
		if (!oldRecord) {
			const rssPost = await fetchRssItemForPath(path);
			if (!rssPost || !rssPost.content) {
				dbOld.close();
				render(root, { path, oldHtml: "", newHtml: "", post: { title: path, link: path, guid: path, pubDate: Date.now() }, status: "无法从 RSS 读取 content:encoded" });
				return;
			}
			oldRecord = {
				path,
				guid: rssPost.guid,
				link: rssPost.link,
				title: rssPost.title,
				pubDate: rssPost.pubDate,
				description: rssPost.description,
				html: normalizeRaw(rssPost.content),
				lockedAt: Date.now(),
			};
			await idbPut(dbOld, oldRecord);
		}
		dbOld.close();

		const dbNew = await openDb(NEW_DB_NAME);
		const newRecord = await idbGet(dbNew, path);
		dbNew.close();

		const post = {
			title: oldRecord.title || path,
			link: oldRecord.link || path,
			guid: oldRecord.guid || path,
			pubDate: oldRecord.pubDate || Date.now(),
		};

		render(root, {
			path,
			oldHtml: oldRecord.html || "",
			newHtml: newRecord?.html || oldRecord.html || "",
			oldTitle: oldRecord.title || "",
			newTitle: newRecord?.title || oldRecord.title || "",
			oldDesc: oldRecord.description || "",
			newDesc: newRecord?.description || oldRecord.description || "",
			post,
			status: "调试已开启：原逻辑已禁用，仅允许伪造 DIFF",
		});

		const maybeDiff = computeDiffWithMeta(oldRecord, newRecord || {});
		if (maybeDiff) {
			setDebugStateForCurrentPost(post, maybeDiff);
			ensureDiffUrl();
			dispatchApply();
		}
	}

	document.addEventListener("DOMContentLoaded", init);
	document.addEventListener("swup:contentReplaced", init);
</script>
